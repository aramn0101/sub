<!DOCTYPE html>
<html>
  <head>
    <title>Auto-Loading Subtitles</title>
  </head>
  <body>
    <video id="videoPlayer" controls></video>

    <script>
      const videoPlayer = document.getElementById("videoPlayer");
      const videoURL =
        "https://api.onedrive.com/v1.0/shares/s!AtbDU6WSkdycoGa5ER_wfVYoXVdq/root/content";

      fetchSubtitles(videoURL)
        .then((subtitlesURL) => {
          videoPlayer.addEventListener("loadedmetadata", function () {
            const textTrack = videoPlayer.addTextTrack(
              "captions",
              "English",
              "en"
            );
            textTrack.mode = "showing";
            textTrack.src = subtitlesURL;
          });

          videoPlayer.src = videoURL;
        })
        .catch((error) => {
          videoPlayer.src = videoURL;
        });

      function fetchSubtitles(videoURL) {
        return new Promise((resolve, reject) => {
          const worker = new Worker("ffmpeg-worker-webm.js");

          worker.onmessage = function (event) {
            const { type, data } = event.data;
            if (type === "ffmpeg-stdout") {
              const output = data.trim();
              const subtitlesMatch = output.match(
                /(.*Stream #.*:.*Subtitle:.*vobsub.*)/i
              );
              if (subtitlesMatch) {
                const subtitles = subtitlesMatch[1].trim();
                const vttBlob = new Blob([subtitles], { type: "text/vtt" });
                const subtitlesURL = URL.createObjectURL(vttBlob);
                resolve(subtitlesURL);
              } else {
                reject("No subtitles found in the video.");
              }
            } else if (type === "ffmpeg-stderr") {
              reject(data);
            }
          };

          worker.postMessage({ type: "run", arguments: ["-i", videoURL] });
        });
      }
    </script>
  </body>
</html>
